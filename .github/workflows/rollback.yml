name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'The commit SHA to rollback to'
        required: true
      reason:
        description: 'Reason for rollback'
        required: true
        default: 'Production issue detected'

jobs:
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: Notify Rollback Start
        run: |
          echo "ğŸ”„ Starting rollback..."
          echo "Commit: ${{ github.event.inputs.commit_sha }}"
          echo "Reason: ${{ github.event.inputs.reason }}"

      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "ğŸ”„ å¼€å§‹å›æ»šæ“ä½œ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*å›æ»šåˆ°*: ${{ github.event.inputs.commit_sha }}\n*åŸå› *: ${{ github.event.inputs.reason }}\n*æ“ä½œè€…*: ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Rollback on Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            echo "ğŸ”„ Rolling back to ${{ github.event.inputs.commit_sha }}..."

            # ç¡®å®šå½“å‰è¿è¡Œçš„å®¹å™¨
            if docker ps | grep -q "class-system-blue"; then
              CURRENT_COLOR="blue"
            elif docker ps | grep -q "class-system-green"; then
              CURRENT_COLOR="green"
            else
              echo "Error: No production container running"
              exit 1
            fi

            echo "Current environment: $CURRENT_COLOR"

            # æ‹‰å–æŒ‡å®šç‰ˆæœ¬çš„é•œåƒ
            docker pull yinghuiwang00/class-system:${{ github.event.inputs.commit_sha }}

            # æ ‡è®°ä¸º production
            docker tag yinghuiwang00/class-system:${{ github.event.inputs.commit_sha }} \
                       yinghuiwang00/class-system:rollback

            # åœæ­¢å½“å‰å®¹å™¨
            docker stop class-system-$CURRENT_COLOR

            # åˆ é™¤å›æ»šå®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            docker rm class-system-rollback || true

            # å¯åŠ¨å›æ»šç‰ˆæœ¬
            docker run -d \
              --name class-system-rollback \
              -p 8082:8080 \
              -e SPRING_PROFILES_ACTIVE=production \
              -e SPRING_DATASOURCE_URL=${{ secrets.PRODUCTION_DB_URL }} \
              -e SPRING_DATASOURCE_USERNAME=${{ secrets.PRODUCTION_DB_USERNAME }} \
              -e SPRING_DATASOURCE_PASSWORD=${{ secrets.PRODUCTION_DB_PASSWORD }} \
              -e JWT_SECRET=${{ secrets.PRODUCTION_JWT_SECRET }} \
              --restart unless-stopped \
              --health-cmd="curl -f http://localhost:8080/actuator/health || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              yinghuiwang00/class-system:rollback

            echo "â³ Waiting for rollback version to be healthy..."

            # ç­‰å¾…å¥åº·æ£€æŸ¥
            MAX_ATTEMPTS=60
            ATTEMPT=0
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              if curl -f http://localhost:8082/actuator/health; then
                echo "âœ… Rollback version is healthy!"

                # å¥åº·ååˆ‡æ¢æµé‡
                # è¿™é‡Œéœ€è¦æ›´æ–°è´Ÿè½½å‡è¡¡å™¨é…ç½®

                break
              fi
              ATTEMPT=$((ATTEMPT+1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
              sleep 2
            done

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Rollback version failed health check!"
              exit 1
            fi

            echo "âœ… Rollback completed successfully!"

      - name: Verify Rollback
        run: |
          echo "ğŸ” Verifying rollback..."
          sleep 10

          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.example.com/actuator/health)

          if [ $response -ne 200 ]; then
            echo "âŒ Rollback verification failed! Status: $response"
            exit 1
          fi

          echo "âœ… Rollback verification passed!"

      - name: Notify Rollback Success
        if: success()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "âœ… å›æ»šæˆåŠŸï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*å›æ»šåˆ°*: ${{ github.event.inputs.commit_sha }}\n*æ“ä½œè€…*: ${{ github.actor }}\n*æ—¶é—´*: $(date +'%Y-%m-%d %H:%M:%S')"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Rollback Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "âŒ å›æ»šå¤±è´¥ï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*é”™è¯¯*: è¯·ç«‹å³æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒï¼\n*å›æ»šç‰ˆæœ¬*: ${{ github.event.inputs.commit_sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
