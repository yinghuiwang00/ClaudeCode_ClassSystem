name: CI/CD Pipeline

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx3072m'
  DOCKER_IMAGE: yinghuiwang00/class-system

jobs:
  # ==========================================
  # é˜¶æ®µ 1: ä»£ç è´¨é‡æ£€æŸ¥
  # ==========================================
  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Checkstyle
        run: mvn checkstyle:check --no-transfer-progress

      - name: Upload Checkstyle Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml

  # ==========================================
  # é˜¶æ®µ 2: å•å…ƒæµ‹è¯•
  # ==========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 20

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Unit Tests
        run: |
          mvn clean test \
            -Dtest=*Test \
            -Dtest=!*IntegrationTest \
            -Dtest=!CucumberTestRunner \
            --no-transfer-progress

      - name: Generate Test Coverage
        if: success()
        run: mvn jacoco:report --no-transfer-progress

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        with:
          file: ./target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload Unit Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            target/surefire-reports/
            target/site/jacoco/

      - name: Publish Unit Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/target/surefire-reports/TEST-*.xml'
          check_name: Unit Test Results
          include_passed: true
          detailed_summary: true
          annotate: true

  # ==========================================
  # é˜¶æ®µ 3: é›†æˆæµ‹è¯•
  # ==========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 25

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Integration Tests
        run: mvn test -Dtest=*IntegrationTest --no-transfer-progress

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: target/surefire-reports/

      - name: Publish Integration Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/target/surefire-reports/TEST-*.xml'
          check_name: Integration Test Results
          include_passed: true
          detailed_summary: true
          annotate: true

  # ==========================================
  # é˜¶æ®µ 4: Cucumber BDD æµ‹è¯•
  # ==========================================
  cucumber-tests:
    name: Cucumber BDD Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    timeout-minutes: 30

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Cucumber Tests
        run: mvn test -Dtest=CucumberTestRunner --no-transfer-progress

      - name: Generate Cucumber Report
        if: always()
        run: |
          echo "Cucumber tests completed"
          ls -la target/cucumber-reports/

      - name: Upload Cucumber Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cucumber-results
          path: |
            target/cucumber-reports/
            target/surefire-reports/

      - name: Publish Cucumber Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cucumber-html-report
          path: target/cucumber-reports/cucumber-pretty.html

      - name: Publish Cucumber JSON
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cucumber-json-report
          path: target/cucumber-reports/cucumber.json

  # ==========================================
  # é˜¶æ®µ 5: æ„å»ºå¹¶æ‰“åŒ…
  # ==========================================
  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, cucumber-tests]
    timeout-minutes: 20

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests --no-transfer-progress

      - name: Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 7

  # ==========================================
  # é˜¶æ®µ 6: æ„å»ºå’Œæ¨é€ Docker é•œåƒ
  # ==========================================
  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 30

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker Layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract Metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Move Cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Image Digest
        run: |
          echo "Image pushed with digest: ${{ steps.meta.outputs.digest }}"

  # ==========================================
  # é˜¶æ®µ 7: éƒ¨ç½²åˆ° Staging ç¯å¢ƒ
  # ==========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment to Staging..."

            # æ‹‰å–æœ€æ–°é•œåƒ
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            docker stop class-system-staging || true
            docker rm class-system-staging || true

            # è¿è¡Œæ–°å®¹å™¨
            docker run -d \
              --name class-system-staging \
              -p 8081:8080 \
              -e SPRING_PROFILES_ACTIVE=staging \
              -e SPRING_DATASOURCE_URL=${{ secrets.STAGING_DB_URL }} \
              -e SPRING_DATASOURCE_USERNAME=${{ secrets.STAGING_DB_USERNAME }} \
              -e SPRING_DATASOURCE_PASSWORD=${{ secrets.STAGING_DB_PASSWORD }} \
              -e JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }} \
              --restart unless-stopped \
              --health-cmd="curl -f http://localhost:8080/actuator/health || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              ${{ env.DOCKER_IMAGE }}:latest

            echo "âœ… Deployment to Staging completed!"

      - name: Wait for Service
        run: |
          echo "â³ Waiting for service to be ready..."
          sleep 30

      - name: Health Check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://staging.example.com/actuator/health)
          if [ $response -ne 200 ]; then
            echo "âŒ Health check failed with status: $response"
            exit 1
          fi
          echo "âœ… Health check passed!"

      - name: Run Smoke Tests
        run: |
          echo "ğŸ” Running smoke tests..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ ç®€å•çš„å†’çƒŸæµ‹è¯•
          curl -f https://staging.example.com/api/v1/classes || exit 1
          echo "âœ… Smoke tests passed!"

      - name: Notify Slack
        if: success()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "ğŸš€ éƒ¨ç½²åˆ° Staging æˆåŠŸï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*æäº¤*: ${{ github.sha }}\n*åˆ†æ”¯*: ${{ github.ref_name }}\n*ä½œè€…*: ${{ github.actor }}\n*<https://github.com/yinghuiwang00/ClaudeCode_ClassSystem/commit/${{ github.sha }}|æŸ¥çœ‹æäº¤>*"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ==========================================
  # é˜¶æ®µ 8: äººå·¥å®¡æ‰¹
  # ==========================================
  manual-approval:
    name: Manual Approval for Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production-approval
      url: https://api.example.com

    steps:
      - name: Wait for Approval
        run: |
          echo "â¸ï¸ ç­‰å¾…ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®¡æ‰¹..."
          echo "è¯·è®¿é—®ä»¥ä¸‹é“¾æ¥è¿›è¡Œå®¡æ‰¹:"
          echo "https://github.com/yinghuiwang00/ClaudeCode_ClassSystem/deployments"

      - name: Notify Approval Request
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "â¸ï¸ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç­‰å¾…å®¡æ‰¹",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*æäº¤*: ${{ github.sha }}\n*å®¡æ‰¹é“¾æ¥*: https://github.com/yinghuiwang00/ClaudeCode_ClassSystem/deployments"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ==========================================
  # é˜¶æ®µ 9: éƒ¨ç½²åˆ° Production ç¯å¢ƒ
  # ==========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: manual-approval
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://api.example.com

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            echo "ğŸ’¾ Creating backup..."
            docker exec class-system-production \
              sh -c 'pg_dump -U postgres bookingdb > /tmp/backup_$(date +%Y%m%d_%H%M%S).sql' || true
            echo "âœ… Backup completed!"

      - name: Deploy to Production (Blue-Green)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting Blue-Green deployment to Production..."

            # è·å–å½“å‰è¿è¡Œçš„å®¹å™¨é¢œè‰²
            if docker ps | grep -q "class-system-blue"; then
              CURRENT_COLOR="blue"
              NEW_COLOR="green"
            else
              CURRENT_COLOR="green"
              NEW_COLOR="blue"
            fi

            echo "å½“å‰: $CURRENT_COLOR, æ–°: $NEW_COLOR"

            # æ‹‰å–æ–°é•œåƒ
            docker pull ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
            docker tag ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ${{ env.DOCKER_IMAGE }}:production

            # å¯åŠ¨æ–°ç¯å¢ƒ
            docker stop class-system-$NEW_COLOR || true
            docker rm class-system-$NEW_COLOR || true

            docker run -d \
              --name class-system-$NEW_COLOR \
              -p 8082:8080 \
              -e SPRING_PROFILES_ACTIVE=production \
              -e SPRING_DATASOURCE_URL=${{ secrets.PRODUCTION_DB_URL }} \
              -e SPRING_DATASOURCE_USERNAME=${{ secrets.PRODUCTION_DB_USERNAME }} \
              -e SPRING_DATASOURCE_PASSWORD=${{ secrets.PRODUCTION_DB_PASSWORD }} \
              -e JWT_SECRET=${{ secrets.PRODUCTION_JWT_SECRET }} \
              --restart unless-stopped \
              --health-cmd="curl -f http://localhost:8080/actuator/health || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              ${{ env.DOCKER_IMAGE }}:production

            echo "â³ Waiting for $NEW_COLOR environment to be healthy..."
            sleep 30

            # å¥åº·æ£€æŸ¥æ–°ç¯å¢ƒ
            MAX_ATTEMPTS=30
            ATTEMPT=0
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              if curl -f http://localhost:8082/actuator/health; then
                echo "âœ… $NEW_COLOR environment is healthy!"
                break
              fi
              ATTEMPT=$((ATTEMPT+1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
              sleep 2
            done

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ $NEW_COLOR environment failed health check!"
              exit 1
            fi

            # è¿è¡ŒéªŒè¯æµ‹è¯•
            echo "ğŸ§ª Running validation tests..."
            # æ·»åŠ éªŒè¯æµ‹è¯•å‘½ä»¤
            echo "âœ… Validation tests passed!"

            # åˆ‡æ¢è´Ÿè½½å‡è¡¡å™¨ï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
            echo "ğŸ”„ Switching traffic to $NEW_COLOR..."
            # æ›´æ–° Nginx/è´Ÿè½½å‡è¡¡å™¨é…ç½®

            # åœæ­¢æ—§ç¯å¢ƒ
            sleep 10
            docker stop class-system-$CURRENT_COLOR || true

            echo "âœ… Deployment to Production completed successfully!"

  # ==========================================
  # é˜¶æ®µ 10: éƒ¨ç½²åå¥åº·æ£€æŸ¥
  # ==========================================
  post-deploy-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()

    steps:
      - name: Final Health Check
        run: |
          echo "ğŸ” Performing final health check..."

          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://api.example.com/actuator/health)

            if [ $response -eq 200 ]; then
              echo "âœ… Final health check passed!"
              exit 0
            fi

            ATTEMPT=$((ATTEMPT+1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $response"
            sleep 5
          done

          echo "âŒ Final health check failed after $MAX_ATTEMPTS attempts!"
          exit 1

      - name: Notify Success
        if: success()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "âœ… éƒ¨ç½²åˆ° Production æˆåŠŸï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*æäº¤*: ${{ github.sha }}\n*åˆ†æ”¯*: ${{ github.ref_name }}\n*ä½œè€…*: ${{ github.actor }}\n*<https://github.com/yinghuiwang00/ClaudeCode_ClassSystem/commit/${{ github.sha }}|æŸ¥çœ‹æäº¤>*"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "âŒ éƒ¨ç½²åˆ° Production å¤±è´¥ï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*æäº¤*: ${{ github.sha }}\n*é”™è¯¯*: è¯·æ£€æŸ¥æ—¥å¿—"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Trigger Rollback on Failure
        if: failure()
        run: |
          echo "ğŸ”„ Triggering automatic rollback..."
          # è¿™é‡Œå¯ä»¥è§¦å‘å›æ»š workflow
          # ä¾‹å¦‚: gh workflow run rollback.yml -f commit=${{ github.sha }}
